<!DOCTYPE html>
<!-- Updated: 2025-01-27 - All features now working -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Maya Chatbot">
    <meta name="theme-color" content="#4CAF50">
    <meta name="description" content="Learn Singapore Malay through interactive conversations, quizzes, and daily phrases with Maya chatbot">
    <title>Maya - Interactive Malay Learning Chatbot</title>
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjAiIGZpbGw9IiM0Q0FGNTASIP8vZ74dGVyb24+CjxtYXNrIGlkPSJtYXNrMCI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSJ3aGl0ZSIvPgo8L21hc2s+CjxnIG1hc2s9InVybCgjbWFzazApIj4KPHRleHQgeD0iOTAiIHk9IjkwIiBmb250LXNpemU9IjgwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGFsaWdubWVudC1iYXNlbGluZT0iY2VudHJhbCI+4L+OPC90ZXh0Pgo8L2c+Cjwvc3ZnPgo=">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzRDQUY1MCISIP8vZ74dGVyb24+CjxtYXNrIGlkPSJtYXNrMCI+CjxyZWN0IHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0id2hpdGUiLz4KPC9tYXNrPgo8ZyBtYXNrPSJ1cmwoI21hc2swKSI+Cjx0ZXh0IHg9IjE2IiB5PSIxNiIgZm9udC1zaXplPSIyMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBhbGlnbm1lbnQtYmFzZWxpbmU9ImNlbnRyYWwiPk08L3RleHQ+CjwvZz4KPC9zdmc+Cg==">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            text-align: center;
            color: #2E7D32;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .header p {
            font-size: 14px;
            color: #666;
        }
        .nav-menu {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .nav-btn:hover, .nav-btn.active {
            background: #2E7D32;
        }
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .section {
            display: none;
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .section.active {
            display: block;
        }
        .section h2 {
            color: #2E7D32;
            margin-bottom: 15px;
        }
        .quiz-themes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .theme-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .theme-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
        }
        .theme-card h3 {
            color: #2E7D32;
            font-size: 16px;
            margin-bottom: 8px;
        }
        .theme-card p {
            color: #666;
            font-size: 14px;
        }
        .quiz-question {
            background: #fff !important;
            color: #222 !important;
        }
        .quiz-question h4 {
            color: #2E7D32 !important;
        }
        .quiz-options {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }
        .quiz-option {
            background: #2E7D32 !important;
            color: #fff !important;
            border: 2px solid #4CAF50 !important;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }
        .quiz-option:hover {
            background: #388e3c !important;
        }
        .quiz-option:disabled {
            background: #bbb !important;
            color: #fff !important;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .score {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin: 20px 0;
        }
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .user-message {
            background: #4CAF50;
            color: white;
            margin-left: auto;
        }
        .bot-message {
            background: rgba(255,255,255,0.95);
            color: #2E7D32;
        }
        .bilingual {
            font-style: italic;
            opacity: 0.8;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .input-container {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            display: flex;
            gap: 10px;
        }
        #messageInput {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
        }
        #sendButton {
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }
        .topics-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .all-topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .topic-category {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .topic-category h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }

        .topic-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
        }

        .quick-reply {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
            text-align: center;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-reply:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* Responsive design for mobile */
        @media (max-width: 768px) {
            /* Mobile-first approach */
            body {
                font-size: 14px;
                line-height: 1.5;
            }

            .header {
                padding: 10px 15px;
                position: sticky;
                top: 0;
                z-index: 100;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .header h1 {
                font-size: 1.3em;
                margin-bottom: 5px;
            }

            .header p {
                font-size: 0.85em;
            }

            .nav-menu {
                padding: 8px 10px;
                gap: 5px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .nav-btn {
                min-width: 80px;
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }

            .content-area {
                padding: 10px;
                margin-bottom: 80px; /* Space for fixed input */
            }

            .all-topics-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-top: 15px;
            }

            .topic-category {
                padding: 12px;
                margin-bottom: 10px;
            }

            .topic-category h4 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .topic-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .quick-reply {
                font-size: 11px;
                padding: 10px 8px;
                min-height: 44px; /* Apple's recommended touch target */
                border-radius: 15px;
                line-height: 1.2;
            }

            /* Chat interface optimizations */
            .chat-container {
                max-height: 50vh;
                padding: 10px;
                margin-bottom: 10px;
            }

            .message {
                max-width: 90%;
                padding: 8px 12px;
                font-size: 14px;
                line-height: 1.4;
            }

            /* Fixed input at bottom for mobile */
            .input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 10px 15px;
                background: rgba(255,255,255,0.95);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(0,0,0,0.1);
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
                z-index: 1000;
            }

            #messageInput {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 14px 16px;
                border-radius: 20px;
                height: auto;
                min-height: 44px;
            }

            #sendButton {
                padding: 14px 20px;
                min-height: 44px;
                font-size: 14px;
                border-radius: 20px;
            }

            /* Quiz mobile optimizations */
            .quiz-themes {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 0 5px;
            }

            .theme-card {
                padding: 15px;
                margin-bottom: 10px;
                cursor: pointer;
                touch-action: manipulation;
            }

            .theme-card h3 {
                font-size: 1.1em;
                margin-bottom: 8px;
            }

            .theme-card p {
                font-size: 0.9em;
                line-height: 1.3;
            }

            .quiz-question {
                margin-bottom: 20px;
                padding: 15px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .quiz-question h4 {
                font-size: 1em;
                margin-bottom: 15px;
                line-height: 1.4;
            }

            .quiz-options {
                display: grid;
                gap: 8px;
            }

            .quiz-option {
                padding: 12px 16px;
                min-height: 44px;
                font-size: 14px;
                border: 2px solid #ddd;
                border-radius: 10px;
                background: white;
                cursor: pointer;
                transition: all 0.2s ease;
                text-align: left;
                line-height: 1.3;
                touch-action: manipulation;
            }

            .quiz-option:hover, .quiz-option:active {
                border-color: #4CAF50;
                transform: scale(0.98);
            }

            /* Daily phrases mobile */
            .phrase-container {
                margin-bottom: 20px;
                padding: 0 10px;
            }

            .current-phrase {
                padding: 20px 15px;
                margin-bottom: 15px;
            }

            .phrase-malay {
                font-size: 1.8em;
                margin-bottom: 8px;
            }

            .phrase-english {
                font-size: 1.2em;
                margin-bottom: 15px;
            }

            .week-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 0 10px;
            }

            .week-btn {
                padding: 12px 8px;
                font-size: 13px;
            }

            .phrases-list {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 0 10px;
            }

            /* Improve touch interactions */
            .btn {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 14px;
                touch-action: manipulation;
            }

            /* Hide hover effects on touch devices */
            .quick-reply:hover {
                transform: none;
                box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
            }

            .theme-card:hover {
                transform: none;
            }
        }

        /* Extra small phones */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.1em;
            }

            .nav-btn {
                min-width: 70px;
                padding: 6px 10px;
                font-size: 11px;
            }

            .topic-buttons {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .quick-reply {
                font-size: 12px;
                padding: 12px 15px;
                text-align: center;
            }

            .week-buttons {
                grid-template-columns: 1fr;
            }

            .phrase-malay {
                font-size: 1.5em;
            }

            .phrase-english {
                font-size: 1.1em;
            }

            .content-area {
                padding: 8px;
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .chat-container {
                max-height: 30vh;
            }

            .content-area {
                margin-bottom: 70px;
            }

            .input-container {
                padding: 8px 15px;
            }
        }

        /* PWA and touch improvements */
        * {
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            -webkit-touch-callout: none;
        }

        button, .btn, .quick-reply, .theme-card, .quiz-option {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .input-container {
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }

            #messageInput {
                font-size: 16px; /* Prevent zoom */
            }
        }

        /* üéÆ GAMIFICATION STYLES */
        .player-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .daily-progress-bar {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .daily-progress {
            background: linear-gradient(90deg, #FFD700, #FFA500);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .theme-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #2E7D32);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 11px;
            color: #666;
            min-width: 35px;
        }

        /* Animations */
        @keyframes pointsPopUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -70%) scale(1); opacity: 0; }
        }

        @keyframes levelUpFade {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes levelUpBounce {
            0% { transform: scale(0.3); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes badgeSlideIn {
            0% { transform: translateX(100%); }
            20% { transform: translateX(0); }
            80% { transform: translateX(0); }
            100% { transform: translateX(100%); }
        }

        @keyframes streakPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .streak-active {
            animation: streakPulse 0.5s ease-in-out;
        }

        /* Badge display */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .badge-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .badge-card.unlocked {
            border-color: #FFD700;
            background: rgba(255,215,0,0.1);
        }

        .badge-card.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        /* Mobile optimizations for gamification */
        @media (max-width: 768px) {
            .player-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 12px 15px;
                margin-bottom: 15px;
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 11px;
            }

            .badges-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .badge-card {
                padding: 10px;
                font-size: 12px;
            }
        }
        .roleplay-scenarios {
            display: grid;
            gap: 15px;
        }
        .scenario-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
        }
        .btn:hover {
            background: #2E7D32;
        }
        .dialogue-preview {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid #4CAF50;
        }
        .dialogue-preview p {
            margin: 5px 0;
            color: #2E7D32;
            font-size: 14px;
        }

        /* Daily Phrases Styles */
        .phrase-container {
            max-width: 800px;
            margin: 0 auto 30px;
        }

        .current-phrase {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .phrase-header h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }

        .phrase-meta {
            opacity: 0.9;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .phrase-malay {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .phrase-english {
            font-size: 1.4em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .phrase-audio-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .phrase-audio-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .phrase-navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .nav-phrase-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .nav-phrase-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .week-selector {
            text-align: center;
            margin-bottom: 30px;
        }

        .week-selector h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .week-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
        }

        .week-btn {
            background: white;
            border: 2px solid #3498db;
            color: #3498db;
            padding: 15px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .week-btn:hover, .week-btn.active {
            background: #3498db;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .week-btn small {
            display: block;
            font-weight: normal;
            opacity: 0.8;
            margin-top: 5px;
        }

        .phrases-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .phrase-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
            transition: transform 0.3s ease;
        }

        .phrase-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .phrase-card-category {
            color: #3498db;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .phrase-card-malay {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .phrase-card-english {
            color: #666;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .phrase-card-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .phrase-card-btn:hover {
            background: #2980b9;
        }

        .feedback-section a:hover {
    text-decoration: underline;
    opacity: 0.9;
}

@media (max-width: 768px) {
    .feedback-section {
        margin: 15px 5px;
        padding: 10px;
    }
}
    </style>
</head>
<body>
    <div class="header">
        <h1>üá∏üá¨ Maya - Interactive Malay Learning Chatbot</h1>
        <p>Learn Singapore Malay through conversation, quizzes, and role-playing scenarios</p>
        <div id="installPrompt" style="display: none; margin-top: 10px;">
            <button id="installButton" style="background: #2E7D32; color: white; border: none; padding: 8px 16px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                üì± Install App
            </button>
        </div>
    </div>
    
    <div class="nav-menu">
        <button class="nav-btn active" onclick="showSection('home')">Home</button>
        <button class="nav-btn" onclick="showSection('chat')">Interactive Chat</button>
        <button class="nav-btn" onclick="showSection('quiz')">Quiz</button>
        <button class="nav-btn" onclick="showSection('phrases')">Daily Phrases</button>
        <button class="nav-btn" onclick="window.location.href='mailto:sgmalayclass@gmail.com?subject=Feedback%20for%20Maya%20Chatbot'">Feedback</button>
    </div>
    
    <div class="content-area">
        <!-- Home Section -->
        <div class="section active" id="home">
            <h2>Welcome to Maya! üåü</h2>
            
            <!-- üéÆ Player Stats -->
            <div class="player-stats">
                <div class="stat-item">
                    <div class="stat-value" id="player-level">1</div>
                    <div class="stat-label">Level</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="player-points">0</div>
                    <div class="stat-label">‚≠ê Points</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="current-streak">0</div>
                    <div class="stat-label">üî• Streak</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="badges-count">0</div>
                    <div class="stat-label">üèÜ Badges</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="daily-points">0/20</div>
                    <div class="stat-label">üìÖ Daily Goal</div>
                    <div class="daily-progress-bar">
                        <div class="daily-progress" id="daily-progress"></div>
                    </div>
                </div>
            </div>
            
            <p><strong>What is Maya?</strong><br>
            Maya is your friendly Singapore Malay learning companion! Practice conversational Malay, test your knowledge with quizzes, and engage in real-life scenarios.</p>
            
            <p><strong>Features:</strong><br>
            üó£Ô∏è <strong>Interactive Chat:</strong> Practice conversations and role-playing scenarios with English translations<br>
            üß† <strong>Knowledge Quiz:</strong> Test your vocabulary and grammar across 14 different themes<br>
            üìÖ <strong>Daily Phrases:</strong> Learn essential phrases through an 8-week structured program<br>
            üåç <strong>Singapore Context:</strong> Learn authentic Singapore Malay expressions</p>
            
            <p><strong>How to use:</strong><br>
            Click on the tabs above to navigate between different learning modes. Start with Daily Phrases to learn essential vocabulary, then practice with Chat conversations!</p>

            <!-- Feedback Section -->
            <div style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #4CAF50, #2E7D32); border-radius: 15px; color: white; text-align: center;">
                <h3 style="color: white; margin-bottom: 15px; font-size: 24px;">üìù Send Us Your Feedback!</h3>
                <p style="margin-bottom: 20px; font-size: 16px;">Help us improve Maya! We value your suggestions, comments, and bug reports.</p>
                <a href="mailto:sgmalayclass@gmail.com" style="
                    display: inline-block;
                    padding: 12px 25px;
                    background: white;
                    color: #4CAF50;
                    text-decoration: none;
                    border-radius: 25px;
                    font-weight: bold;
                    font-size: 18px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    transition: all 0.3s ease;">
                    ‚úâÔ∏è sgmalayclass@gmail.com
                </a>
            </div>

            <!-- üèÜ Badges Section -->
            <div style="margin-top: 30px;">
                <h3 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">üèÜ Your Badges & Achievements</h3>
                <div class="badges-grid" id="badges-grid">
                    <!-- Badges will be populated here -->
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="section" id="chat">
            <h2>üí¨ Chat with Maya</h2>
            <div class="chat-container" id="chat-container">
                <div class="message bot-message">
                    Selamat datang! Saya Maya. Mari bercakap dalam Bahasa Melayu! üòä
                    <div class="bilingual">Welcome! I'm Maya. Let's chat in Malay!</div>
                </div>
            </div>
            
                <div class="input-container">
        <input type="text" id="messageInput" placeholder="Type your message in Malay..." 
               onkeypress="if(event.key==='Enter') sendMessage()">
        <button id="sendButton" onclick="sendMessage()">Hantar</button>
    </div>
</div>

        <!-- Quiz Section -->
        <div class="section" id="quiz">
            <h2>üß† Malay Quiz - Choose Your Theme</h2>
            <div class="quiz-themes" id="quiz-themes">
                <div class="theme-card" onclick="startQuiz('greetings')">
                    <h3>ü§ù Greetings & Politeness</h3>
                    <p>Basic greetings, please, thank you, and polite expressions</p>
                    <div class="theme-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-greetings" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progress-text-greetings">0/7</div>
                    </div>
                </div>
                <div class="theme-card" onclick="startQuiz('family')">
                    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family & Relationships</h3>
                    <p>Family members, relationships, and personal connections</p>
                </div>
                <div class="theme-card" onclick="startQuiz('food')">
                    <h3>üçú Food & Drinks</h3>
                    <p>Hawker center favorites, local dishes, and beverages</p>
                </div>
                <div class="theme-card" onclick="startQuiz('transport')">
                    <h3>üöá Transportation</h3>
                    <p>MRT, buses, taxis, and getting around Singapore</p>
                </div>
                <div class="theme-card" onclick="startQuiz('shopping')">
                    <h3>üõí Shopping</h3>
                    <p>Markets, malls, bargaining, and making purchases</p>
                </div>
                <div class="theme-card" onclick="startQuiz('numbers')">
                    <h3>üî¢ Numbers & Time</h3>
                    <p>Counting, telling time, dates, and quantities</p>
                </div>
                <div class="theme-card" onclick="startQuiz('body')">
                    <h3>üè• Body & Health</h3>
                    <p>Body parts, health conditions, and medical terms</p>
                </div>
                <div class="theme-card" onclick="startQuiz('colors')">
                    <h3>üåà Colors & Descriptions</h3>
                    <p>Colors, sizes, shapes, and descriptive words</p>
                </div>
                <div class="theme-card" onclick="startQuiz('weather')">
                    <h3>üå¶Ô∏è Weather & Nature</h3>
                    <p>Weather conditions, seasons, and natural elements</p>
                </div>
                <div class="theme-card" onclick="startQuiz('home')">
                    <h3>üè† Home & Living</h3>
                    <p>House parts, furniture, and household items</p>
                </div>
                <div class="theme-card" onclick="startQuiz('work')">
                    <h3>üíº Work & School</h3>
                    <p>Occupations, school subjects, and workplace terms</p>
                </div>
                <div class="theme-card" onclick="startQuiz('hobbies')">
                    <h3>üé® Hobbies & Activities</h3>
                    <p>Sports, entertainment, and leisure activities</p>
                </div>
                <div class="theme-card" onclick="startQuiz('directions')">
                    <h3>üß≠ Directions & Places</h3>
                    <p>Locations, directions, and navigating around town</p>
                </div>
                <div class="theme-card" onclick="startQuiz('emotions')">
                    <h3>üòä Emotions & Feelings</h3>
                    <p>Expressing feelings, emotions, and personal states</p>
                </div>
            </div>
            
            <div id="quiz-content" style="display: none;">
                <button class="btn" onclick="backToThemes()">‚Üê Back to Themes</button>
                <div id="quiz-questions"></div>
                <div class="score" id="quiz-score">Score: 0/0</div>
                    </div>
    </div>

    <!-- Daily Phrases Section -->
    <div id="phrases" class="section">
        <h2>üìÖ Malay Phrase of the Day</h2>
        <p class="subtitle">Learn essential Malay phrases organized by weekly themes</p>
        
        <div class="phrase-container">
            <div class="current-phrase">
                <div class="phrase-header">
                    <h3 id="phrase-title">üìÖ Today's Phrase</h3>
                    <div class="phrase-meta">
                        <span id="phrase-week">Week 1</span> ‚Ä¢ <span id="phrase-category">Greetings</span>
                    </div>
                </div>
                <div class="phrase-content">
                    <div class="phrase-malay" id="phrase-malay">Selamat pagi</div>
                    <div class="phrase-english" id="phrase-english">Good morning</div>
                    <button class="phrase-audio-btn" onclick="speakPhrase()">üîä Listen</button>
                </div>
            </div>
            
            <div class="phrase-navigation">
                <button class="nav-phrase-btn" onclick="previousPhrase()">‚Üê Previous Phrase</button>
                <button class="nav-phrase-btn" onclick="randomPhrase()">üé≤ Random Phrase</button>
                <button class="nav-phrase-btn" onclick="nextPhrase()">Next Phrase ‚Üí</button>
                <button class="nav-phrase-btn" onclick="testSpeech()" style="background: #e74c3c;">üîä Test Audio</button>
            </div>
        </div>
        
        <div class="week-selector">
            <h3>üìö Browse Other Weeks</h3>
            <div class="week-buttons">
                <button class="week-btn active" onclick="selectWeek(1)">Week 1<br><small>Survival Essentials</small></button>
                <button class="week-btn" onclick="selectWeek(2)">Week 2<br><small>Shopping & Directions</small></button>
                <button class="week-btn" onclick="selectWeek(3)">Week 3<br><small>Time & Daily Life</small></button>
                <button class="week-btn" onclick="selectWeek(4)">Week 4<br><small>Social & Emergencies</small></button>
                <button class="week-btn" onclick="selectWeek(5)">Week 5<br><small>Home & Community</small></button>
                <button class="week-btn" onclick="selectWeek(6)">Week 6<br><small>Workplace & Studies</small></button>
                <button class="week-btn" onclick="selectWeek(7)">Week 7<br><small>Culture & Media</small></button>
                <button class="week-btn" onclick="selectWeek(8)">Week 8<br><small>Advanced Scenarios</small></button>
            </div>
        </div>
        
        <div class="current-week-section">
            <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">üìñ This Week's Complete Phrase Collection</h3>
            <div class="phrases-list" id="phrases-list">
                <!-- Phrases will be populated here -->
            </div>
        </div>
    </div>

 
    </div>
    
    <div class="input-container">
        <input type="text" id="messageInput" placeholder="Type your message in Malay..." 
               onkeypress="if(event.key==='Enter') sendMessage()">
        <button id="sendButton" onclick="sendMessage()">Hantar</button>
    </div>

    <script>
        let currentSection = 'home';
        let quizScore = 0;
        let quizTotal = 0;
        let currentQuiz = null;
        let currentTopic = null;
        let conversationStep = 0;
        let conversationContext = {};
        let currentPhraseIndex = 0;
        let currentWeek = 1;

        // üéÆ GAMIFICATION SYSTEM
        let playerProfile = {
            name: 'Student',
            level: 1,
            totalPoints: 0,
            totalQuizzes: 0,
            correctAnswers: 0,
            currentStreak: 0,
            longestStreak: 0,
            badges: [],
            dailyGoal: 20, // points needed per day
            dailyPoints: 0,
            lastPlayDate: null,
            themeProgress: {}, // track progress per theme
            achievements: [],
            phrasesMastered: 0,
            conversationsCompleted: 0
        };

        // Badge definitions
        const badges = {
            'first_quiz': { name: 'üéØ First Quiz', description: 'Complete your first quiz!', points: 10 },
            'perfect_score': { name: 'üíØ Perfect Score', description: 'Get 100% on any quiz!', points: 50 },
            'streak_5': { name: 'üî• Hot Streak', description: '5 correct answers in a row!', points: 30 },
            'streak_10': { name: '‚ö° Lightning Streak', description: '10 correct answers in a row!', points: 100 },
            'daily_goal': { name: 'üìÖ Daily Champion', description: 'Reach daily goal!', points: 25 },
            'phrase_master': { name: 'üó£Ô∏è Phrase Master', description: 'Listen to 50 phrases!', points: 40 },
            'theme_expert': { name: 'üèÜ Theme Expert', description: 'Complete all themes!', points: 200 },
            'conversation_starter': { name: 'üí¨ Conversation Starter', description: 'Try 10 different topics!', points: 60 },
            'level_5': { name: '‚≠ê Rising Star', description: 'Reach Level 5!', points: 75 },
            'level_10': { name: 'üåü Malay Master', description: 'Reach Level 10!', points: 150 }
        };

        // Achievement definitions
        const achievements = {
            'greetings_master': { name: 'ü§ù Greetings Master', requirement: 'greetings', threshold: 7 },
            'food_expert': { name: 'üçú Food Expert', requirement: 'food', threshold: 7 },
            'quiz_champion': { name: 'üèÜ Quiz Champion', requirement: 'total_quizzes', threshold: 20 },
            'phrase_enthusiast': { name: 'üìö Phrase Enthusiast', requirement: 'phrases_mastered', threshold: 100 }
        };

        // Load player profile from localStorage
        function loadPlayerProfile() {
            const saved = localStorage.getItem('maya_player_profile');
            if (saved) {
                playerProfile = { ...playerProfile, ...JSON.parse(saved) };
            }
            
            // Check if it's a new day
            const today = new Date().toDateString();
            if (playerProfile.lastPlayDate !== today) {
                playerProfile.dailyPoints = 0;
                playerProfile.lastPlayDate = today;
            }
            
            updateProfileDisplay();
        }

        // Save player profile
        function savePlayerProfile() {
            localStorage.setItem('maya_player_profile', JSON.stringify(playerProfile));
        }

        // Add points and check for level ups/badges
        function addPoints(points, reason = '') {
            playerProfile.totalPoints += points;
            playerProfile.dailyPoints += points;
            
            // Check for level up
            const newLevel = Math.floor(playerProfile.totalPoints / 100) + 1;
            if (newLevel > playerProfile.level) {
                playerProfile.level = newLevel;
                showLevelUpAnimation(newLevel);
                checkBadges();
            }
            
            // Check daily goal
            if (playerProfile.dailyPoints >= playerProfile.dailyGoal) {
                unlockBadge('daily_goal');
            }
            
            // Show points gained
            if (points > 0) {
                showPointsGained(points, reason);
            }
            
            updateProfileDisplay();
            savePlayerProfile();
        }

        // Unlock badge
        function unlockBadge(badgeId) {
            if (!playerProfile.badges.includes(badgeId)) {
                playerProfile.badges.push(badgeId);
                const badge = badges[badgeId];
                addPoints(badge.points, 'Badge Bonus');
                showBadgeUnlocked(badge);
            }
        }

        // Check for new badges and achievements
        function checkBadges() {
            // Level badges
            if (playerProfile.level >= 5) unlockBadge('level_5');
            if (playerProfile.level >= 10) unlockBadge('level_10');
            
            // Streak badges
            if (playerProfile.currentStreak >= 5) unlockBadge('streak_5');
            if (playerProfile.currentStreak >= 10) unlockBadge('streak_10');
            
            // Progress badges
            if (playerProfile.phrasesMastered >= 50) unlockBadge('phrase_master');
            if (playerProfile.conversationsCompleted >= 10) unlockBadge('conversation_starter');
            
            // Theme completion
            const completedThemes = Object.values(playerProfile.themeProgress).filter(p => p >= 7).length;
            if (completedThemes >= 14) unlockBadge('theme_expert');
        }

        // Update profile display
        function updateProfileDisplay() {
            // Update header stats
            document.getElementById('player-level').textContent = playerProfile.level;
            document.getElementById('player-points').textContent = playerProfile.totalPoints;
            document.getElementById('daily-progress').style.width = 
                `${Math.min(100, (playerProfile.dailyPoints / playerProfile.dailyGoal) * 100)}%`;
            document.getElementById('daily-points').textContent = 
                `${playerProfile.dailyPoints}/${playerProfile.dailyGoal}`;
            
            // Update streak
            document.getElementById('current-streak').textContent = playerProfile.currentStreak;
            
            // Update badges count
            document.getElementById('badges-count').textContent = playerProfile.badges.length;
            
            // Update badges display
            updateBadgesDisplay();
        }

        // Show animations and notifications
        function showPointsGained(points, reason) {
            const notification = document.createElement('div');
            notification.className = 'points-gained';
            notification.innerHTML = `
                <div class="points-animation">
                    +${points} ‚≠ê
                    ${reason ? `<br><small>${reason}</small>` : ''}
                </div>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #FFD700, #FFA500);
                color: #1a1a1a;
                padding: 15px 25px;
                border-radius: 25px;
                font-weight: bold;
                font-size: 18px;
                z-index: 10000;
                animation: pointsPopUp 2s ease-out forwards;
                text-align: center;
                box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => document.body.removeChild(notification), 2000);
        }

        function showLevelUpAnimation(level) {
            const animation = document.createElement('div');
            animation.innerHTML = `
                <div class="level-up">
                    üéâ LEVEL UP! üéâ
                    <div class="level-number">Level ${level}</div>
                    <div class="level-subtitle">Keep learning!</div>
                </div>
            `;
            animation.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
                animation: levelUpFade 3s ease-out forwards;
            `;
            
            animation.querySelector('.level-up').style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                animation: levelUpBounce 1s ease-out;
            `;
            
            document.body.appendChild(animation);
            setTimeout(() => document.body.removeChild(animation), 3000);
        }

        function showBadgeUnlocked(badge) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div class="badge-unlock">
                    ${badge.name}
                    <div class="badge-desc">${badge.description}</div>
                    <div class="badge-points">+${badge.points} ‚≠ê</div>
                </div>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50, #2E7D32);
                color: white;
                padding: 20px;
                border-radius: 15px;
                z-index: 10000;
                animation: badgeSlideIn 3s ease-out forwards;
                max-width: 250px;
                box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => document.body.removeChild(notification), 3000);
        }

        // Daily Phrases Data - 8 weeks of essential Malay phrases
        const phrasesData = {
            1: {
                title: "Survival Essentials & Greetings",
                categories: {
                    "Greetings": [
                        { malay: "Selamat pagi", english: "Good morning" },
                        { malay: "Apa khabar?", english: "How are you?" },
                        { malay: "Khabar baik", english: "I'm fine" },
                        { malay: "Terima kasih", english: "Thank you" },
                        { malay: "Sama-sama", english: "You're welcome" }
                    ],
                    "Food & Drinks": [
                        { malay: "Saya lapar", english: "I'm hungry" },
                        { malay: "Saya dahaga", english: "I'm thirsty" },
                        { malay: "Boleh saya lihat menu?", english: "Can I see the menu?" },
                        { malay: "Saya nak pesan...", english: "I want to order..." },
                        { malay: "Ada nasi ayam?", english: "Do you have chicken rice?" },
                        { malay: "Bilik air di mana?", english: "Where is the toilet?" }
                    ],
                    "Polite Requests": [
                        { malay: "Boleh tolong saya?", english: "Can you help me?" },
                        { malay: "Maaf", english: "Sorry/Excuse me" },
                        { malay: "Boleh...?", english: "Can I/May I...?" }
                    ]
                }
            },
            2: {
                title: "Shopping & Getting Around",
                categories: {
                    "Shopping": [
                        { malay: "Berapa harganya?", english: "How much is this?" },
                        { malay: "Mahal sangat!", english: "Too expensive!" },
                        { malay: "Ada diskaun?", english: "Is there a discount?" },
                        { malay: "Saya cuma tengok", english: "I'm just looking" },
                        { malay: "Boleh bayar dengan kad?", english: "Can I pay by card?" }
                    ],
                    "Directions": [
                        { malay: "Di mana stesen bas?", english: "Where is the bus station?" },
                        { malay: "Di mana stesen teksi?", english: "Where is the taxi station?" },
                        { malay: "Belok kiri", english: "Turn left" },
                        { malay: "Belok kanan", english: "Turn right" },
                        { malay: "Jalan terus", english: "Go straight" },
                        { malay: "Jauh ke...?", english: "Is it far to...?" },
                        { malay: "Saya sesat", english: "I'm lost" }
                    ],
                    "Transport": [
                        { malay: "Teksi!", english: "Taxi!" },
                        { malay: "Berapa tambang ke...?", english: "How much is the fare to...?" },
                        { malay: "Berhenti di sini", english: "Stop here" }
                    ]
                }
            },
            3: {
                title: "Time, Weather & Daily Life",
                categories: {
                    "Time & Dates": [
                        { malay: "Pukul berapa?", english: "What time is it?" },
                        { malay: "Hari ini hari apa?", english: "What day is today?" },
                        { malay: "Esok", english: "Tomorrow" },
                        { malay: "Semalam", english: "Yesterday" },
                        { malay: "Minggu depan", english: "Next week" },
                        { malay: "Minggu lepas", english: "Last week" }
                    ],
                    "Weather": [
                        { malay: "Hari ini panas", english: "Today is hot" },
                        { malay: "Hari ini hujan", english: "Today is rainy" },
                        { malay: "Ada ribut petir", english: "There's a thunderstorm" },
                        { malay: "Cuaca baik", english: "The weather is good" },
                        { malay: "Berapa suhu?", english: "What's the temperature?" }
                    ],
                    "Daily Activities": [
                        { malay: "Saya bangun pukul...", english: "I wake up at..." },
                        { malay: "Saya pergi kerja", english: "I go to work" },
                        { malay: "Saya bersenam", english: "I exercise" },
                        { malay: "Makan malam pukul lapan", english: "Dinner at 8 pm" }
                    ]
                }
            },
            4: {
                title: "Social Interactions & Emergencies",
                categories: {
                    "Socializing": [
                        { malay: "Awak berasal dari mana?", english: "Where are you from?" },
                        { malay: "Apa hobi awak?", english: "What's your hobby?" },
                        { malay: "Jumpa lagi!", english: "See you again!" },
                        { malay: "Boleh saya ambil gambar?", english: "Can I take a photo?" }
                    ],
                    "Feelings & Opinions": [
                        { malay: "Saya gembira", english: "I'm happy" },
                        { malay: "Saya sedih", english: "I'm sad" },
                        { malay: "Saya tak faham", english: "I don't understand" },
                        { malay: "Saya setuju", english: "I agree" },
                        { malay: "Tak setuju", english: "I disagree" },
                        { malay: "Awak pandai cakap Bahasa Melayu!", english: "You speak Malay well!" }
                    ],
                    "Health & Emergencies": [
                        { malay: "Saya tak sihat", english: "I'm unwell" },
                        { malay: "Saya demam", english: "I have fever" },
                        { malay: "Saya sakit perut", english: "I have stomachache" },
                        { malay: "Tolong panggil doktor!", english: "Please call a doctor!" },
                        { malay: "Di mana hospital terdekat?", english: "Where's the nearest hospital?" },
                        { malay: "Tolong!", english: "Help!" }
                    ]
                }
            },
            5: {
                title: "Home & Community",
                categories: {
                    "Housing": [
                        { malay: "Rumah sewa", english: "Rental house" },
                        { malay: "Bil elektrik", english: "Electricity bill" },
                        { malay: "Bil air", english: "Water bill" },
                        { malay: "Buang sampah hari apa?", english: "Which day is garbage collection?" },
                        { malay: "Paip rosak", english: "The pipe is leaking" }
                    ],
                    "Neighborhood": [
                        { malay: "Kami jiran baru", english: "We're new neighbors" },
                        { malay: "Ada kedai runcit berhampiran?", english: "Is there a grocery store nearby?" },
                        { malay: "Kawasan ini selamat?", english: "Is this area safe?" },
                        { malay: "Bising sikit pada waktu malam", english: "It's a bit noisy at night" }
                    ],
                    "Local Services": [
                        { malay: "Tolong panggil tukang elektrik", english: "Please call an electrician" },
                        { malay: "Pejabat pos di mana?", english: "Where's the post office?" },
                        { malay: "Ada menu penghantar makanan?", english: "Do you have a food delivery menu?" }
                    ]
                }
            },
            6: {
                title: "Workplace & Studies",
                categories: {
                    "Professional Phrases": [
                        { malay: "Boleh saya minta cuti?", english: "Can I request leave?" },
                        { malay: "Meeting bermula pukul berapa?", english: "What time does the meeting start?" },
                        { malay: "Fail ini untuk siapa?", english: "Who is this file for?" },
                        { malay: "Saya perlukan lebih masa", english: "I need more time" }
                    ],
                    "Campus/School": [
                        { malay: "Kuliah dibatalkan hari ini", english: "Lecture is canceled today" },
                        { malay: "Bila tarikh hantar kerja kursus?", english: "When is the assignment due?" },
                        { malay: "Perpustakaan buka hingga pukul berapa?", english: "Until when is the library open?" }
                    ],
                    "Networking": [
                        { malay: "Boleh saya ada kad nama awak?", english: "May I have your business card?" },
                        { malay: "Kita boleh berhubung melalui email", english: "We can connect via email" },
                        { malay: "Syarikat anda buat apa?", english: "What does your company do?" }
                    ]
                }
            },
            7: {
                title: "Culture & Media",
                categories: {
                    "Festivals/Traditions": [
                        { malay: "Apa maksud adat ini?", english: "What's the meaning of this custom?" },
                        { malay: "Selamat Hari Raya!", english: "Happy Eid!" },
                        { malay: "Selamat Aidilfitri!", english: "Happy Eid!" },
                        { malay: "Baju kurung", english: "Traditional Malay dress (female)" },
                        { malay: "Baju Melayu", english: "Traditional Malay attire (male)" },
                        { malay: "Boleh saya cuba makanan ini?", english: "Can I try this food?" }
                    ],
                    "Entertainment": [
                        { malay: "Filem tempatan yang best?", english: "Any good local movies?" },
                        { malay: "Konsert diadakan di mana?", english: "Where's the concert held?" },
                        { malay: "Lagu ni siapa nyanyi?", english: "Who sings this song?" }
                    ],
                    "Expressing Opinions": [
                        { malay: "Pada pendapat saya...", english: "In my opinion..." },
                        { malay: "Saya minat seni tempatan", english: "I'm interested in local art" },
                        { malay: "Tak berapa gemar", english: "I don't really like it" }
                    ]
                }
            },
            8: {
                title: "Advanced Scenarios & Troubleshooting",
                categories: {
                    "Tech Issues": [
                        { malay: "Wi-Fi tak berfungsi", english: "Wi-Fi isn't working" },
                        { malay: "Boleh reset kata laluan?", english: "Can you reset the password?" },
                        { malay: "Peranti tak boleh disambung", english: "Device won't connect" }
                    ],
                    "Complaints/Issues": [
                        { malay: "Pesanan saya salah", english: "My order is wrong" },
                        { malay: "Bilik hotel kotor", english: "The hotel room is dirty" },
                        { malay: "Saya nak buat aduan", english: "I want to make a complaint" }
                    ],
                    "Official Matters": [
                        { malay: "Dokumen untuk visa", english: "Documents for a visa" },
                        { malay: "Cara isi borang ini?", english: "How to fill this form?" },
                        { malay: "Pejabat imigresen dekat sini?", english: "Is the immigration office nearby?" }
                    ]
                }
            }
        };

        // Quiz data for all 14 themes - Now with 7 questions each!
        const quizData = {
            greetings: [
                { question: "What does 'Terima kasih' mean?", options: ["Good morning", "Thank you", "Excuse me", "How are you"], correct: 1 },
                { question: "How do you say 'Good morning' in Malay?", options: ["Selamat malam", "Selamat petang", "Selamat pagi", "Selamat tengahari"], correct: 2 },
                { question: "What does 'Maaf' mean?", options: ["Sorry", "Please", "Welcome", "Goodbye"], correct: 0 },
                { question: "How do you say 'You're welcome'?", options: ["Terima kasih", "Sama-sama", "Maaf", "Selamat tinggal"], correct: 1 },
                { question: "What does 'Selamat tinggal' mean?", options: ["Good luck", "Goodbye", "See you later", "Take care"], correct: 1 },
                { question: "How do you say 'Please' in Malay?", options: ["Maaf", "Sila", "Tolong", "Boleh"], correct: 1 },
                { question: "What does 'Apa khabar?' mean?", options: ["What's your name?", "How are you?", "Where are you from?", "What time is it?"], correct: 1 }
            ],
            family: [
                { question: "What does 'Ayah' mean?", options: ["Mother", "Father", "Brother", "Sister"], correct: 1 },
                { question: "How do you say 'older sister' in Malay?", options: ["Kakak", "Adik", "Ibu", "Nenek"], correct: 0 },
                { question: "What does 'Cucu' mean?", options: ["Child", "Grandchild", "Nephew", "Cousin"], correct: 1 },
                { question: "How do you say 'family' in Malay?", options: ["Rumah", "Keluarga", "Kawan", "Jiran"], correct: 1 },
                { question: "What does 'Nenek' mean?", options: ["Grandfather", "Grandmother", "Aunt", "Uncle"], correct: 1 },
                { question: "How do you say 'younger sibling' in Malay?", options: ["Kakak", "Adik", "Sepupu", "Anak"], correct: 1 },
                { question: "What does 'Bapa' mean?", options: ["Father", "Mother", "Uncle", "Brother"], correct: 0 }
            ],
            food: [
                { question: "What is 'Nasi lemak'?", options: ["Fried rice", "Coconut rice", "White rice", "Rice noodles"], correct: 1 },
                { question: "What does 'Minum' mean?", options: ["Eat", "Drink", "Cook", "Buy"], correct: 1 },
                { question: "What is 'Teh tarik'?", options: ["Coffee", "Pulled tea", "Ice cream", "Soup"], correct: 1 },
                { question: "What does 'Pedas' mean?", options: ["Sweet", "Sour", "Spicy", "Salty"], correct: 2 },
                { question: "What is 'Char kway teow'?", options: ["Fried noodles", "Rice cake", "Soup", "Dessert"], correct: 0 },
                { question: "What does 'Lapar' mean?", options: ["Thirsty", "Hungry", "Full", "Tired"], correct: 1 },
                { question: "How do you say 'delicious' in Malay?", options: ["Pahit", "Sedap", "Masam", "Tawar"], correct: 1 }
            ],
            transport: [
                { question: "What does 'Bas' mean?", options: ["Train", "Bus", "Car", "Bicycle"], correct: 1 },
                { question: "How do you say 'MRT station' in Malay?", options: ["Stesen bas", "Stesen MRT", "Lapangan terbang", "Pelabuhan"], correct: 1 },
                { question: "What does 'Teksi' mean?", options: ["Bus", "Train", "Taxi", "Motorcycle"], correct: 2 },
                { question: "How do you say 'airport' in Malay?", options: ["Stesen", "Lapangan terbang", "Pelabuhan", "Jalan raya"], correct: 1 },
                { question: "What does 'Keretapi' mean?", options: ["Car", "Train", "Bicycle", "Boat"], correct: 1 },
                { question: "How do you say 'ticket' in Malay?", options: ["Tiket", "Kad", "Wang", "Kunci"], correct: 0 },
                { question: "What does 'Naik' mean in transport context?", options: ["Get off", "Get on", "Wait", "Run"], correct: 1 }
            ],
            shopping: [
                { question: "What does 'Berapa harga?' mean?", options: ["What color?", "How much?", "Where is?", "What time?"], correct: 1 },
                { question: "How do you say 'cheap' in Malay?", options: ["Mahal", "Murah", "Besar", "Kecil"], correct: 1 },
                { question: "What does 'Beli' mean?", options: ["Sell", "Buy", "Look", "Want"], correct: 1 },
                { question: "How do you say 'expensive' in Malay?", options: ["Murah", "Cantik", "Mahal", "Bagus"], correct: 2 },
                { question: "What does 'Jual' mean?", options: ["Buy", "Sell", "Give", "Take"], correct: 1 },
                { question: "How do you say 'discount' in Malay?", options: ["Potongan", "Tambahan", "Harga", "Bayar"], correct: 0 },
                { question: "What does 'Bayar' mean?", options: ["Pay", "Count", "Change", "Return"], correct: 0 }
            ],
            numbers: [
                { question: "What is 'Lima' in English?", options: ["Three", "Four", "Five", "Six"], correct: 2 },
                { question: "How do you say '10' in Malay?", options: ["Sembilan", "Sepuluh", "Sebelas", "Lapan"], correct: 1 },
                { question: "What does 'Pukul berapa?' mean?", options: ["How many?", "What time?", "How much?", "Which day?"], correct: 1 },
                { question: "What is 'Satu' in English?", options: ["One", "Two", "Three", "Zero"], correct: 0 },
                { question: "How do you say 'twenty' in Malay?", options: ["Dua belas", "Dua puluh", "Dua ratus", "Dua ribu"], correct: 1 },
                { question: "What is 'Lapan' in English?", options: ["Seven", "Eight", "Nine", "Ten"], correct: 1 },
                { question: "How do you say 'first' in Malay?", options: ["Pertama", "Kedua", "Ketiga", "Terakhir"], correct: 0 }
            ],
            body: [
                { question: "What does 'Kepala' mean?", options: ["Hand", "Head", "Foot", "Eye"], correct: 1 },
                { question: "How do you say 'sick' in Malay?", options: ["Sihat", "Sakit", "Penat", "Lapar"], correct: 1 },
                { question: "What does 'Mata' mean?", options: ["Nose", "Mouth", "Eye", "Ear"], correct: 2 },
                { question: "How do you say 'hand' in Malay?", options: ["Kaki", "Tangan", "Badan", "Muka"], correct: 1 },
                { question: "What does 'Mulut' mean?", options: ["Nose", "Mouth", "Ear", "Throat"], correct: 1 },
                { question: "How do you say 'healthy' in Malay?", options: ["Sakit", "Sihat", "Lemah", "Kuat"], correct: 1 },
                { question: "What does 'Perut' mean?", options: ["Chest", "Back", "Stomach", "Shoulder"], correct: 2 }
            ],
            colors: [
                { question: "What does 'Merah' mean?", options: ["Blue", "Green", "Red", "Yellow"], correct: 2 },
                { question: "How do you say 'white' in Malay?", options: ["Hitam", "Putih", "Abu-abu", "Coklat"], correct: 1 },
                { question: "What does 'Besar' mean?", options: ["Small", "Big", "Long", "Short"], correct: 1 },
                { question: "How do you say 'beautiful' in Malay?", options: ["Hodoh", "Cantik", "Buruk", "Kotor"], correct: 1 },
                { question: "What does 'Kuning' mean?", options: ["Purple", "Yellow", "Orange", "Pink"], correct: 1 },
                { question: "How do you say 'black' in Malay?", options: ["Putih", "Hitam", "Kelabu", "Coklat"], correct: 1 },
                { question: "What does 'Kecil' mean?", options: ["Big", "Small", "Tall", "Wide"], correct: 1 }
            ],
            weather: [
                { question: "What does 'Hujan' mean?", options: ["Sun", "Rain", "Wind", "Cloud"], correct: 1 },
                { question: "How do you say 'hot' in Malay?", options: ["Sejuk", "Panas", "Basah", "Kering"], correct: 1 },
                { question: "What does 'Angin' mean?", options: ["Rain", "Sun", "Wind", "Storm"], correct: 2 },
                { question: "How do you say 'cold' in Malay?", options: ["Panas", "Sejuk", "Lembap", "Kering"], correct: 1 },
                { question: "What does 'Mendung' mean?", options: ["Sunny", "Cloudy", "Windy", "Foggy"], correct: 1 },
                { question: "How do you say 'sunny' in Malay?", options: ["Hujan", "Cerah", "Gelap", "Sejuk"], correct: 1 },
                { question: "What does 'Ribut' mean?", options: ["Drizzle", "Snow", "Storm", "Mist"], correct: 2 }
            ],
            home: [
                { question: "What does 'Rumah' mean?", options: ["Room", "House", "Kitchen", "Bathroom"], correct: 1 },
                { question: "How do you say 'bedroom' in Malay?", options: ["Dapur", "Bilik tidur", "Ruang tamu", "Bilik air"], correct: 1 },
                { question: "What does 'Katil' mean?", options: ["Chair", "Table", "Bed", "Door"], correct: 2 },
                { question: "How do you say 'kitchen' in Malay?", options: ["Dapur", "Bilik", "Tingkap", "Pintu"], correct: 0 },
                { question: "What does 'Tingkap' mean?", options: ["Door", "Window", "Wall", "Roof"], correct: 1 },
                { question: "How do you say 'bathroom' in Malay?", options: ["Dapur", "Bilik air", "Ruang tamu", "Bilik tidur"], correct: 1 },
                { question: "What does 'Kerusi' mean?", options: ["Table", "Chair", "Sofa", "Bed"], correct: 1 }
            ],
            work: [
                { question: "What does 'Kerja' mean?", options: ["Study", "Work", "Play", "Sleep"], correct: 1 },
                { question: "How do you say 'teacher' in Malay?", options: ["Pelajar", "Cikgu", "Doktor", "Jurutera"], correct: 1 },
                { question: "What does 'Sekolah' mean?", options: ["Office", "Hospital", "School", "Shop"], correct: 2 },
                { question: "How do you say 'student' in Malay?", options: ["Cikgu", "Pelajar", "Pekerja", "Doktor"], correct: 1 },
                { question: "What does 'Pejabat' mean?", options: ["School", "Office", "Factory", "Store"], correct: 1 },
                { question: "How do you say 'doctor' in Malay?", options: ["Jururawat", "Doktor", "Cikgu", "Jurutera"], correct: 1 },
                { question: "What does 'Gaji' mean?", options: ["Job", "Salary", "Boss", "Meeting"], correct: 1 }
            ],
            hobbies: [
                { question: "What does 'Bola sepak' mean?", options: ["Basketball", "Football", "Tennis", "Swimming"], correct: 1 },
                { question: "How do you say 'read' in Malay?", options: ["Tulis", "Baca", "Dengar", "Tengok"], correct: 1 },
                { question: "What does 'Lagu' mean?", options: ["Dance", "Song", "Movie", "Book"], correct: 1 },
                { question: "How do you say 'swim' in Malay?", options: ["Lari", "Berenang", "Lompat", "Berjalan"], correct: 1 },
                { question: "What does 'Lukis' mean?", options: ["Sing", "Draw", "Dance", "Write"], correct: 1 },
                { question: "How do you say 'music' in Malay?", options: ["Musik", "Nyanyian", "Tarian", "Filem"], correct: 0 },
                { question: "What does 'Berlari' mean?", options: ["Walk", "Run", "Jump", "Sit"], correct: 1 }
            ],
            directions: [
                { question: "What does 'Kiri' mean?", options: ["Right", "Left", "Straight", "Back"], correct: 1 },
                { question: "How do you say 'near' in Malay?", options: ["Jauh", "Dekat", "Tinggi", "Rendah"], correct: 1 },
                { question: "What does 'Jalan' mean?", options: ["House", "Road", "Bridge", "Building"], correct: 1 },
                { question: "How do you say 'where is?' in Malay?", options: ["Bila?", "Apa?", "Kat mana?", "Kenapa?"], correct: 2 },
                { question: "What does 'Kanan' mean?", options: ["Left", "Right", "Straight", "Behind"], correct: 1 },
                { question: "How do you say 'far' in Malay?", options: ["Dekat", "Jauh", "Tinggi", "Besar"], correct: 1 },
                { question: "What does 'Terus' mean in directions?", options: ["Turn", "Stop", "Straight", "Back"], correct: 2 }
            ],
            emotions: [
                { question: "What does 'Gembira' mean?", options: ["Sad", "Angry", "Happy", "Tired"], correct: 2 },
                { question: "How do you say 'angry' in Malay?", options: ["Sedih", "Marah", "Takut", "Penat"], correct: 1 },
                { question: "What does 'Takut' mean?", options: ["Brave", "Scared", "Calm", "Excited"], correct: 1 },
                { question: "How do you say 'love' in Malay?", options: ["Benci", "Sayang", "Suka", "Rindu"], correct: 1 },
                { question: "What does 'Sedih' mean?", options: ["Happy", "Sad", "Excited", "Calm"], correct: 1 },
                { question: "How do you say 'excited' in Malay?", options: ["Bosan", "Teruja", "Penat", "Malas"], correct: 1 },
                { question: "What does 'Rindu' mean?", options: ["Hate", "Miss/long for", "Forget", "Remember"], correct: 1 }
            ]
        };

        // Keyword detection patterns
        const keywords = {
            greetings: ['selamat', 'pagi', 'petang', 'malam', 'khabar', 'apa', 'hai', 'hello', 'terima kasih', 'thank you'],
            food: ['nasi', 'ayam', 'makan', 'minum', 'teh', 'kopi', 'char kway teow', 'laksa', 'roti', 'goreng', 'order', 'lapar'],
            shopping: ['beli', 'harga', 'berapa', 'murah', 'mahal', 'jual', 'kedai', 'pasar', 'kurang', 'bagi'],
            directions: ['mana', 'jalan', 'kiri', 'kanan', 'dekat', 'jauh', 'pergi', 'sampai', 'tengok'],
            numbers: ['satu', 'dua', 'tiga', 'empat', 'lima', 'enam', 'tujuh', 'lapan', 'sembilan', 'sepuluh'],
            help: ['tolong', 'bantu', 'help', 'tak faham', 'boleh', 'can'],
            family: ['ayah', 'ibu', 'anak', 'kakak', 'adik', 'nenek', 'datuk', 'keluarga', 'kahwin', 'isteri', 'suami'],
            work: ['kerja', 'office', 'gaji', 'cuti', 'boss', 'meeting', 'project', 'deadline', 'overtime'],
            health: ['sakit', 'demam', 'batuk', 'doktor', 'ubat', 'hospital', 'clinic', 'sihat', 'penat'],
            transport: ['mrt', 'bas', 'teksi', 'grab', 'stesen', 'tiket', 'ezlink', 'naik', 'turun'],
            weather: ['hujan', 'panas', 'sejuk', 'angin', 'mendung', 'cerah', 'ribut', 'cuaca'],
            hobbies: ['suka', 'hobby', 'baca', 'tengok', 'main', 'bola', 'music', 'lagu', 'filem'],
            school: ['sekolah', 'belajar', 'exam', 'homework', 'cikgu', 'pelajar', 'kelas', 'universiti'],
            time: ['masa', 'pukul', 'jam', 'hari', 'minggu', 'bulan', 'tahun', 'awal', 'lambat'],
            housing: ['rumah', 'sewa', 'rent', 'bilik', 'apartment', 'condo', 'flat', 'hdb'],
            banking: ['bank', 'akaun', 'account', 'money', 'exchange', 'tukar', 'wang', 'atm'],
            jobinterview: ['interview', 'kerja', 'job', 'experience', 'pengalaman', 'gaji', 'salary'],
            hotel: ['hotel', 'daftar', 'check-in', 'bilik', 'room', 'service', 'tetamu'],
            emergency: ['emergency', 'polis', 'police', 'hilang', 'lost', 'ambulans', 'urgent'],
            friends: ['kawan', 'friend', 'jemput', 'invite', 'jumpa', 'meet', 'berkawan'],
            postoffice: ['pos', 'post', 'hantar', 'send', 'bungkusan', 'package', 'setem'],
            cultural: ['kenduri', 'wedding', 'kahwin', 'festival', 'celebration', 'budaya']
        };

        // Extended conversation flow templates (5-7 interactions each)
        const conversationFlows = {
            greetings: [
                { malay: "Selamat datang! Apa khabar hari ini?", english: "Welcome! How are you today?" },
                { malay: "Alhamdulillah, saya sihat. Awak dari mana?", english: "Praise be to God, I'm healthy. Where are you from?" },
                { malay: "Wah, jauh juga! Dah lama duduk sini?", english: "Wow, quite far! Have you been living here long?" },
                { malay: "Bagus! Suka tak duduk kat Singapore?", english: "Great! Do you like living in Singapore?" },
                { malay: "Nak belajar Bahasa Melayu untuk apa?", english: "What do you want to learn Malay for?" },
                { malay: "Okay! Mari kita practice sekarang!", english: "Okay! Let's practice now!" },
                { malay: "Jom cuba conversation yang lain pula!", english: "Let's try another conversation!" }
            ],
            food: [
                { malay: "Selamat datang ke kedai makan! Nak order apa?", english: "Welcome to the food stall! What would you like to order?" },
                { malay: "Kami ada nasi ayam, char kway teow, laksa, dan mee goreng. Mana satu best?", english: "We have chicken rice, char kway teow, laksa, and fried noodles. Which one is the best?" },
                { malay: "Nasi ayam memang sedap! Nak yang biasa ke yang roasted?", english: "Chicken rice is really delicious! Want the regular or roasted?" },
                { malay: "Berapa banyak? Satu jer ke dua?", english: "How many? Just one or two?" },
                { malay: "Nak minuman? Teh tarik, kopi, atau air kosong?", english: "Want drinks? Teh tarik, coffee, or plain water?" },
                { malay: "Pedas tak apa? Saya letak chili sikit.", english: "Spicy is okay? I'll put a little chili." },
                { malay: "Okay, tunggu 10 minit ya. Nanti saya panggilkan nama awak.", english: "Okay, wait 10 minutes. I'll call your name later." }
            ],
            shopping: [
                { malay: "Selamat datang ke kedai! Cari apa hari ini?", english: "Welcome to the shop! What are you looking for today?" },
                { malay: "Oh, awak nak beli buah-buahan? Pisang, epal, oren semua ada.", english: "Oh, you want to buy fruits? Bananas, apples, oranges - we have everything." },
                { malay: "Pisang ni fresh, baru sampai pagi tadi. Berapa kilo nak?", english: "These bananas are fresh, just arrived this morning. How many kilos do you want?" },
                { malay: "Dua kilo? Okay. Harga biasa RM6, tapi saya bagi RM5 je.", english: "Two kilos? Okay. Normal price RM6, but I'll give you RM5." },
                { malay: "Nak beli apa lagi? Epal Australia ni manis tau.", english: "Want to buy anything else? These Australian apples are sweet." },
                { malay: "Total semua RM12. Awak bayar cash ke card?", english: "Total everything RM12. You pay cash or card?" },
                { malay: "Terima kasih! Datang lagi ya! Buah segar selalu ada.", english: "Thank you! Come again! We always have fresh fruits." }
            ],
            directions: [
                { malay: "Eh, awak nampak keliru. Nak pergi mana?", english: "Eh, you look confused. Where do you want to go?" },
                { malay: "Orchard Road? Wah, jauh sikit. Naik MRT lagi senang.", english: "Orchard Road? Wow, quite far. Taking MRT is easier." },
                { malay: "Dari sini jalan ke Bugis MRT, lepas tu naik Green Line.", english: "From here walk to Bugis MRT, then take the Green Line." },
                { malay: "Turun kat Somerset atau Orchard station. Somerset lagi dekat.", english: "Get off at Somerset or Orchard station. Somerset is closer." },
                { malay: "Keluar je dari station, awak dah nampak shopping mall.", english: "As soon as you exit the station, you'll see the shopping mall." },
                { malay: "Journey takes about 20 minutes. Jangan lupa bawa EZ-Link card!", english: "Journey takes about 20 minutes. Don't forget to bring your EZ-Link card!" },
                { malay: "Kalau sesat, tanya kat Information Counter. Diorang boleh tolong.", english: "If you get lost, ask at the Information Counter. They can help." }
            ],
            help: [
                { malay: "Jangan risau, saya boleh tolong awak!", english: "Don't worry, I can help you!" },
                { malay: "Apa yang awak tak faham? Pronunciation ke grammar?", english: "What don't you understand? Pronunciation or grammar?" },
                { malay: "Okay, cuba cakap perlahan-lahan. Saya akan dengar.", english: "Okay, try to speak slowly. I will listen." },
                { malay: "Bagus! Pronunciation awak dah better. Cuba lagi sekali.", english: "Good! Your pronunciation is getting better. Try once more." },
                { malay: "Perfect! Awak dah pandai. Nak belajar perkataan baru?", english: "Perfect! You're getting good. Want to learn new words?" },
                { malay: "Practice makes perfect. Cakap dengan orang Melayu selalu.", english: "Practice makes perfect. Speak with Malay people often." }
            ],
            family: [
                { malay: "Wah, awak ada keluarga besar ke?", english: "Wow, do you have a big family?" },
                { malay: "Berapa orang dalam keluarga awak?", english: "How many people are in your family?" },
                { malay: "Ada adik beradik? Awak anak sulung ke?", english: "Do you have siblings? Are you the eldest?" },
                { malay: "Keluarga awak tinggal dekat ke jauh?", english: "Does your family live nearby or far away?" },
                { malay: "Awak selalu balik rumah tengok family?", english: "Do you often go home to see your family?" },
                { malay: "Sweet! Family memang penting dalam budaya kita.", english: "Sweet! Family is really important in our culture." },
                { malay: "Jaga family baik-baik tau. Diorang sayang awak!", english: "Take good care of your family. They love you!" }
            ],
            work: [
                { malay: "Awak kerja kat mana? Office ke kedai?", english: "Where do you work? Office or shop?" },
                { malay: "Kerja awak best tak? Stress ke santai?", english: "Is your work good? Stressful or relaxed?" },
                { malay: "Pukul berapa awak start kerja pagi-pagi?", english: "What time do you start work in the morning?" },
                { malay: "Boss awak okay tak? Garang ke baik?", english: "Is your boss okay? Fierce or nice?" },
                { malay: "Gaji cukup untuk hidup kat Singapore?", english: "Is the salary enough to live in Singapore?" },
                { malay: "Ada cuti public holiday tak? Boleh rest?", english: "Do you have public holidays off? Can you rest?" },
                { malay: "Kerja kena balance dengan life. Jangan stress sangat!", english: "Work needs to be balanced with life. Don't stress too much!" }
            ],
            health: [
                { malay: "Awak nampak tak sihat hari ni. Apa jadi?", english: "You don't look well today. What happened?" },
                { malay: "Demam ke batuk? Dah berapa hari sakit?", english: "Fever or cough? How many days have you been sick?" },
                { malay: "Dah makan ubat? Atau nak pergi clinic?", english: "Have you taken medicine? Or do you want to go to the clinic?" },
                { malay: "Clinic mana yang dekat? Government ke private?", english: "Which clinic is nearby? Government or private?" },
                { malay: "Jangan lupa bawa IC dan insurance card.", english: "Don't forget to bring your IC and insurance card." },
                { malay: "Minum air banyak-banyak dan rehat cukup.", english: "Drink lots of water and get enough rest." },
                { malay: "Get well soon! Kesihatan tu penting sangat.", english: "Get well soon! Health is very important." }
            ],
            transport: [
                { malay: "Nak pergi mana? Naik apa hari ni?", english: "Where are you going? What transport are you taking today?" },
                { malay: "MRT lagi fast, tapi bas pun okay jugak.", english: "MRT is faster, but bus is also okay." },
                { malay: "EZ-Link card awak ada balance tak?", english: "Does your EZ-Link card have balance?" },
                { malay: "Kalau rush hour, memang jam. Better avoid.", english: "During rush hour, it's definitely jammed. Better avoid." },
                { malay: "Grab mahal sikit, tapi convenient especially kalau hujan.", english: "Grab is a bit expensive, but convenient especially when it's raining." },
                { malay: "Singapore transport system memang best. Very efficient!", english: "Singapore's transport system is really good. Very efficient!" },
                { malay: "Safe travels! Jangan lupa scan when naik dan turun.", english: "Safe travels! Don't forget to scan when getting on and off." }
            ],
            weather: [
                { malay: "Wah, panas gila hari ni! Awak rasa tak?", english: "Wow, it's crazy hot today! Don't you think so?" },
                { malay: "Nampak macam nak hujan. Bawa payung tak?", english: "Looks like it's going to rain. Did you bring an umbrella?" },
                { malay: "Singapore weather memang unpredictable. Hot then suddenly hujan.", english: "Singapore weather is really unpredictable. Hot then suddenly rain." },
                { malay: "Air-con mesti kena on 24/7. Electric bill naik!", english: "Air-con must be on 24/7. Electric bill goes up!" },
                { malay: "Musim tengkujuh ni, selalu ada thunderstorm.", english: "During monsoon season, there are often thunderstorms." },
                { malay: "Best time jalan-jalan evening time, not so hot.", english: "Best time to walk around is evening time, not so hot." },
                { malay: "Stay hydrated! Singapore weather boleh buat dehydrated.", english: "Stay hydrated! Singapore weather can make you dehydrated." }
            ],
            hobbies: [
                { malay: "Awak suka buat apa time free? Ada hobby?", english: "What do you like to do in your free time? Do you have hobbies?" },
                { malay: "Wah, interesting! Dah berapa lama minat benda tu?", english: "Wow, interesting! How long have you been interested in that?" },
                { malay: "Kat Singapore ada club atau group untuk hobby tu?", english: "Are there clubs or groups for that hobby in Singapore?" },
                { malay: "Weekend awak spend time buat hobby ke lepak dengan kawan?", english: "Do you spend weekends doing hobbies or hanging out with friends?" },
                { malay: "Hobby tu expensive tak? Kena spend banyak duit?", english: "Is that hobby expensive? Do you need to spend a lot of money?" },
                { malay: "Bagus la ada hobby! Better than staring at phone je.", english: "Good to have hobbies! Better than just staring at the phone." },
                { malay: "Maybe boleh ajar I someday. I nak belajar new things!", english: "Maybe you can teach me someday. I want to learn new things!" }
            ],
            school: [
                { malay: "Awak student ke working adult? Kat mana study?", english: "Are you a student or working adult? Where do you study?" },
                { malay: "Ambil course apa? Engineering, business, or arts?", english: "What course are you taking? Engineering, business, or arts?" },
                { malay: "Exam period stress tak? Banyak assignments?", english: "Is exam period stressful? Lots of assignments?" },
                { malay: "Lecturer okay tak? Garang ke understanding?", english: "Are the lecturers okay? Strict or understanding?" },
                { malay: "After graduate, nak kerja kat Singapore ke balik kampung?", english: "After graduation, want to work in Singapore or go back hometown?" },
                { malay: "Study group dengan classmates boleh help a lot!", english: "Study groups with classmates can help a lot!" },
                { malay: "All the best for your studies! Education is investment.", english: "All the best for your studies! Education is an investment." }
            ],
            time: [
                { malay: "Eh, pukul berapa sekarang? I lupa tengok jam.", english: "Eh, what time is it now? I forgot to check the time." },
                { malay: "Awak busy tak hari ni? Ada appointment?", english: "Are you busy today? Do you have appointments?" },
                { malay: "Weekend ni ada plan? Nak buat apa?", english: "Do you have plans this weekend? What do you want to do?" },
                { malay: "Time flies so fast! Dah almost end of month.", english: "Time flies so fast! It's almost the end of the month." },
                { malay: "Awak morning person ke night owl? Early bird?", english: "Are you a morning person or night owl? Early bird?" },
                { malay: "Singapore timing sama dengan Malaysia, senang la.", english: "Singapore timing is the same as Malaysia, easy." },
                { malay: "Time management penting, especially kat Singapore everything fast pace!", english: "Time management is important, especially in Singapore where everything is fast-paced!" }
            ],
            housing: [
                { malay: "Awak duduk kat mana? HDB, condo, or landed?", english: "Where do you live? HDB, condo, or landed property?" },
                { malay: "Sewa ke beli? Kat Singapore property mahal gila!", english: "Rent or buy? Property in Singapore is crazy expensive!" },
                { malay: "Berapa bilik? Sharing dengan housemates ke?", english: "How many rooms? Sharing with housemates?" },
                { malay: "Area awak convenient tak? Near MRT?", english: "Is your area convenient? Near MRT?" },
                { malay: "Landlord okay tak? Some can be very demanding.", english: "Is the landlord okay? Some can be very demanding." },
                { malay: "Utilities expensive tak? Aircon bill must be high!", english: "Are utilities expensive? Aircon bill must be high!" },
                { malay: "Singapore housing dream: own property. But so expensive!", english: "Singapore housing dream: own property. But so expensive!" }
            ],
            banking: [
                { malay: "Selamat pagi! Saya mahu buka akaun untuk anak saya.", english: "Good morning! I want to open an account for my child." },
                { malay: "Selamat pagi, Encik. Sila isi borang ini dahulu.", english: "Good morning, sir. Please fill out this form first." },
                { malay: "Terima kasih. Bolehkah saya tukar wang juga?", english: "Thank you. Can I also exchange money?" },
                { malay: "Boleh, Encik. Sila ke kaunter tiga untuk money exchange.", english: "Yes sir. Please go to counter three for money exchange." },
                { malay: "Berapa lama untuk process akaun baru?", english: "How long to process the new account?" },
                { malay: "Dalam masa seminggu, akaun awak akan aktif.", english: "Within a week, your account will be active." }
            ],
            jobinterview: [
                { malay: "Selamat pagi! Boleh perkenalkan diri?", english: "Good morning! Can you introduce yourself?" },
                { malay: "Nama saya Aminah. Saya rajin dan suka belajar.", english: "My name is Aminah. I am hardworking and like to learn." },
                { malay: "Bagus! Apa pengalaman kerja awak?", english: "Good! What is your work experience?" },
                { malay: "Saya pernah bantu di perpustakaan sekolah dan kerja part-time.", english: "I have helped at the school library and worked part-time." },
                { malay: "Kenapa awak berminat dengan jawatan ini?", english: "Why are you interested in this position?" },
                { malay: "Jangan lupa datang awal dan berpakaian kemas kalau dapat kerja.", english: "Don't forget to come early and dress neatly if you get the job." }
            ],
            hotel: [
                { malay: "Selamat petang! Saya mahu daftar masuk.", english: "Good afternoon! I want to check in." },
                { malay: "Selamat petang! Boleh beri kad pengenalan dan booking confirmation?", english: "Good afternoon! Can you give me your ID and booking confirmation?" },
                { malay: "Ada bilik dengan dua katil single?", english: "Do you have a room with two single beds?" },
                { malay: "Ada! Bilik 508. Nak pesan room service?", english: "Yes! Room 508. Want to order room service?" },
                { malay: "Ya, saya mahu nasi goreng dan teh tarik.", english: "Yes, I want fried rice and teh tarik." },
                { malay: "Akan dihantar ke bilik dalam 30 minit. Selamat berehat!", english: "Will be delivered to your room in 30 minutes. Have a good rest!" }
            ],
            emergency: [
                { malay: "Encik polis, anak saya hilang di pasar!", english: "Police officer, my child is lost in the market!" },
                { malay: "Jangan panik, Puan. Apa nama dan umur anak Puan?", english: "Don't panic, Madam. What is your child's name and age?" },
                { malay: "Nama dia Hafiz, umur tujuh tahun. Pakai baju merah.", english: "His name is Hafiz, seven years old. Wearing a red shirt." },
                { malay: "Okay, kami akan broadcast dan cari dia. Puan tunggu di sini.", english: "Okay, we will broadcast and search for him. You wait here." },
                { malay: "Terima kasih, Encik! Saya sangat risau.", english: "Thank you, sir! I am very worried." },
                { malay: "Insya-Allah jumpa. Ramai orang akan tolong cari.", english: "God willing we'll find him. Many people will help search." }
            ],
            friends: [
                { malay: "Hai! Nama saya Farah. Awak siapa?", english: "Hi! My name is Farah. Who are you?" },
                { malay: "Saya Nurul. Saya baru pindah ke area ni.", english: "I'm Nurul. I just moved to this area." },
                { malay: "Welcome! Jom main badminton di taman petang ini!", english: "Welcome! Let's play badminton at the park this evening!" },
                { malay: "Boleh! Pukul berapa? Ada racket extra tak?", english: "Can! What time? Do you have an extra racket?" },
                { malay: "Pukul lima okay? Ada, jangan risau.", english: "Five o'clock okay? Yes, don't worry." },
                { malay: "Perfect! Lepas main boleh minum teh tarik sekali.", english: "Perfect! After playing we can drink teh tarik together." }
            ],
            postoffice: [
                { malay: "Selamat pagi! Saya mahu hantar bungkusan ke Johor.", english: "Good morning! I want to send a package to Johor." },
                { malay: "Bungkusan apa ni? Boleh saya tengok isi kandungan?", english: "What package is this? Can I see the contents?" },
                { malay: "Baju dan makanan kering untuk family. Nak guna pos biasa atau ekspres?", english: "Clothes and dried food for family. Want to use regular or express post?" },
                { malay: "Pos ekspres lagi cepat. Berapa harganya?", english: "Express post is faster. How much does it cost?" },
                { malay: "RM15 untuk ekspres. Nak beli setem juga?", english: "RM15 for express. Want to buy stamps too?" },
                { malay: "Ya, lima setem biasa. Berapa hari sampai Johor?", english: "Yes, five regular stamps. How many days to reach Johor?" }
            ],
            cultural: [
                { malay: "Nenek, kenapa ramai orang hari ini?", english: "Grandmother, why are there so many people today?" },
                { malay: "Hari ini kenduri kahwin sepupu awak, Iqbal.", english: "Today is your cousin's wedding ceremony, Iqbal." },
                { malay: "Wah! Saya mahu beri salam dan hadiah.", english: "Wow! I want to give greetings and a gift." },
                { malay: "Bagus! Jangan lupa ucap 'Selamat Pengantin Baru'.", english: "Good! Don't forget to say 'Congratulations to the newlyweds'." },
                { malay: "Okay Nenek! Makanan apa ada hari ni?", english: "Okay Grandma! What food is there today?" },
                { malay: "Ada nasi minyak, rendang, dan kuih-muih tradisional.", english: "There's nasi minyak, rendang, and traditional cakes." }
            ]
        };

        // Learning progression responses
        const encouragementResponses = [
            { malay: "Bagus! Awak dah pandai!", english: "Good! You're getting better!" },
            { malay: "Betul! Teruskan belajar!", english: "Correct! Keep learning!" },
            { malay: "Hebat! Pronunciation awak bagus!", english: "Great! Your pronunciation is good!" },
            { malay: "Cuba lagi! Practice makes perfect!", english: "Try again! Practice makes perfect!" }
        ];

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            // Show selected section
            document.getElementById(section).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            currentSection = section;
        }

        function startQuiz(theme) {
            currentQuiz = theme;
            quizScore = 0;
            quizTotal = 0;
            
            // Track quiz attempt
            playerProfile.totalQuizzes++;
            
            // First quiz badge
            if (playerProfile.totalQuizzes === 1) {
                unlockBadge('first_quiz');
            }
            
            document.getElementById('quiz-themes').style.display = 'none';
            document.getElementById('quiz-content').style.display = 'block';
            
            const questionsContainer = document.getElementById('quiz-questions');
            questionsContainer.innerHTML = `<h3>üìö ${getThemeTitle(theme)}</h3>`;
            
            quizData[theme].forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                questionDiv.innerHTML = `
                    <h4>Question ${index + 1}: ${q.question}</h4>
                    <div class="quiz-options">
                        ${q.options.map((option, i) => 
                            `<button class="quiz-option" onclick="checkAnswer(this, ${i === q.correct}, ${index})">${option}</button>`
                        ).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });
            
            updateQuizScore();
        }

        function getThemeTitle(theme) {
            const titles = {
                greetings: 'Greetings & Politeness',
                family: 'Family & Relationships',
                food: 'Food & Drinks',
                transport: 'Transportation',
                shopping: 'Shopping',
                numbers: 'Numbers & Time',
                body: 'Body & Health',
                colors: 'Colors & Descriptions',
                weather: 'Weather & Nature',
                home: 'Home & Living',
                work: 'Work & School',
                hobbies: 'Hobbies & Activities',
                directions: 'Directions & Places',
                emotions: 'Emotions & Feelings'
            };
            return titles[theme] || theme;
        }

        function checkAnswer(button, isCorrect, questionIndex) {
            quizTotal++;
            
            if (isCorrect) {
                button.style.background = '#FFD700'; // Yellow for correct answer
                button.style.color = '#000'; // Black text for better contrast on yellow
                quizScore++;
                playerProfile.correctAnswers++;
                playerProfile.currentStreak++;
                
                // Update longest streak
                if (playerProfile.currentStreak > playerProfile.longestStreak) {
                    playerProfile.longestStreak = playerProfile.currentStreak;
                }
                
                // Award points
                addPoints(10, 'Correct Answer');
                
                // Update theme progress
                if (!playerProfile.themeProgress[currentQuiz]) {
                    playerProfile.themeProgress[currentQuiz] = 0;
                }
                playerProfile.themeProgress[currentQuiz]++;
                
                // Streak animation
                const streakElement = document.getElementById('current-streak');
                if (streakElement) {
                    streakElement.classList.add('streak-active');
                    setTimeout(() => streakElement.classList.remove('streak-active'), 500);
                }
                
                // Check badges
                checkBadges();
                
            } else {
                button.style.background = '#f44336'; // Red for wrong answer
                button.style.color = '#fff';
                
                // Reset streak
                playerProfile.currentStreak = 0;
                
                // Highlight correct answer in yellow
                const options = button.parentElement.querySelectorAll('.quiz-option');
                const correctAnswer = quizData[currentQuiz][questionIndex].correct;
                options[correctAnswer].style.background = '#FFD700'; // Yellow for correct answer
                options[correctAnswer].style.color = '#000'; // Black text for better contrast
                options[correctAnswer].style.fontWeight = 'bold'; // Make it stand out more
            }
            
            // Disable all options for this question
            button.parentElement.querySelectorAll('.quiz-option').forEach(opt => {
                opt.disabled = true;
                opt.style.cursor = 'not-allowed';
            });
            
            updateQuizScore();
            updateThemeProgress();
        }

        function updateQuizScore() {
            document.getElementById('quiz-score').textContent = `Score: ${quizScore}/${quizTotal}`;
        }

        function updateThemeProgress() {
            // Update progress bars for all themes
            Object.keys(quizData).forEach(theme => {
                const progress = playerProfile.themeProgress[theme] || 0;
                const maxQuestions = quizData[theme].length;
                const percentage = (progress / maxQuestions) * 100;
                
                const progressBar = document.getElementById(`progress-${theme}`);
                const progressText = document.getElementById(`progress-text-${theme}`);
                
                if (progressBar) {
                    progressBar.style.width = `${Math.min(100, percentage)}%`;
                }
                if (progressText) {
                    progressText.textContent = `${Math.min(progress, maxQuestions)}/${maxQuestions}`;
                }
            });
        }

        function backToThemes() {
            // Check for perfect score before leaving
            if (quizTotal === 7 && quizScore === 7) { // All 7 questions correct
                unlockBadge('perfect_score');
                addPoints(25, 'Perfect Quiz!');
            }
            
            document.getElementById('quiz-themes').style.display = 'grid';
            document.getElementById('quiz-content').style.display = 'none';
            currentQuiz = null;
            
            // Update theme progress display
            updateThemeProgress();
        }

        // Chat functions
        function addMessage(text, isUser, english = null) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.innerHTML = text;
            
            if (english && !isUser) {
                const bilingualDiv = document.createElement('div');
                bilingualDiv.className = 'bilingual';
                bilingualDiv.textContent = english;
                messageDiv.appendChild(bilingualDiv);
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                addMessage(message, true);
                messageInput.value = '';
                
                // Get bot response
                const response = getBotResponse(message);
                addMessage(response.malay, false, response.english);
            }
        }

        function getBotResponse(userMessage) {
            if (currentTopic && conversationFlows[currentTopic]) {
                const responses = conversationFlows[currentTopic];
                
                // Continue conversation flow if within range
                if (conversationStep < responses.length) {
                    const response = responses[conversationStep];
                    conversationStep++;
                    return response;
                }
                
                // After completing the flow, give encouragement and suggest new topics
                if (conversationStep === responses.length) {
                    conversationStep++;
                    const encouragement = encouragementResponses[Math.floor(Math.random() * encouragementResponses.length)];
                    return encouragement;
                }
                
                // After encouragement, suggest new conversation
                if (conversationStep > responses.length) {
                    const followUp = [
                        { malay: "Nak practice topic lain? Cuba click button di bawah!", english: "Want to practice another topic? Try clicking the buttons below!" },
                        { malay: "Mari cuba conversation baru!", english: "Let's try a new conversation!" },
                        { malay: "Cuba roleplay scenario pulak!", english: "Try the roleplay scenarios!" }
                    ];
                    return followUp[Math.floor(Math.random() * followUp.length)];
                }
            }
            
            // Fallback to general helpful responses
            return getGeneralResponse(userMessage);
        }

        function sendQuickReply(malay, english) {
            if (currentSection === 'chat') {
                addMessage(malay, true);
                setTimeout(() => {
                    const response = getContextualResponse(malay);
                    addMessage(response.malay, false, response.english);
                }, 1000);
            }
        }

        function detectTopic(message) {
            const lowerMessage = message.toLowerCase();
            
            for (const [topic, keywordList] of Object.entries(keywords)) {
                for (const keyword of keywordList) {
                    if (lowerMessage.includes(keyword)) {
                        return topic;
                    }
                }
            }
            return 'general';
        }

        function getContextualResponse(userMessage) {
            const detectedTopic = detectTopic(userMessage);
            
            // If we detect a new topic, switch to it
            if (detectedTopic !== 'general' && detectedTopic !== currentTopic) {
                currentTopic = detectedTopic;
                conversationStep = 0;
            }
            
            // If we're in a topic conversation, continue the flow
            if (currentTopic && conversationFlows[currentTopic]) {
                const responses = conversationFlows[currentTopic];
                
                // Continue conversation flow if within range
                if (conversationStep < responses.length) {
                    const response = responses[conversationStep];
                    conversationStep++;
                    return response;
                }
                
                // After completing the flow, give encouragement and suggest new topics
                if (conversationStep === responses.length) {
                    conversationStep++;
                    const encouragement = encouragementResponses[Math.floor(Math.random() * encouragementResponses.length)];
                    return encouragement;
                }
                
                // After encouragement, cycle back or suggest new conversation
                if (conversationStep > responses.length) {
                    const followUp = [
                        { malay: "Nak practice topic lain? Cuba click button di bawah!", english: "Want to practice another topic? Try clicking the buttons below!" },
                        { malay: "Awak dah pandai! Mari cuba conversation baru!", english: "You're getting good! Let's try a new conversation!" },
                        { malay: "Hebat! Sekarang cuba roleplay scenario pulak!", english: "Great! Now try the roleplay scenarios!" }
                    ];
                    return followUp[Math.floor(Math.random() * followUp.length)];
                }
            }
            
            // Fallback to general helpful responses
            return getGeneralResponse(userMessage);
        }

        function getGeneralResponse(message) {
            const generalResponses = [
                { malay: "Maaf, saya tak faham. Boleh repeat?", english: "Sorry, I don't understand. Can you repeat?" },
                { malay: "Cuba cakap dalam Bahasa Melayu.", english: "Try speaking in Malay." },
                { malay: "Saya nak tolong awak belajar! Apa topic yang awak nak?", english: "I want to help you learn! What topic do you want?" },
                { malay: "Mari cuba conversation lain! Selamat pagi!", english: "Let's try another conversation! Good morning!" }
            ];
            
            return generalResponses[Math.floor(Math.random() * generalResponses.length)];
        }

        function resetConversation() {
            currentTopic = null;
            conversationStep = 0;
            conversationContext = {};
        }

        function startTopicConversation(topic) {
            currentTopic = topic;
            conversationStep = 0;
            if (conversationFlows[topic]) {
                const firstResponse = conversationFlows[topic][0];
                addMessage(firstResponse.malay, false, firstResponse.english);
                conversationStep = 1;
            }
        }

        // All topics are now displayed simultaneously in organized categories
        // No need for cycling through different topic sets

        // PWA Installation Support
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        const installPrompt = document.getElementById('installPrompt');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.style.display = 'block';
        });

        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        installPrompt.style.display = 'none';
                    }
                    deferredPrompt = null;
                }
            });
        }

        // Mobile-specific enhancements
        document.addEventListener('DOMContentLoaded', function() {
            // Improve mobile touch performance
            if ('ontouchstart' in window) {
                document.body.classList.add('touch-device');
                
                // Prevent double-tap zoom on buttons
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    var now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }

            // Auto-scroll chat to bottom on mobile
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                const observer = new MutationObserver(() => {
                    if (window.innerWidth <= 768) {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                });
                observer.observe(chatContainer, { childList: true, subtree: true });
            }

            // Improve virtual keyboard handling
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    const inputContainer = document.querySelector('.input-container');
                    if (inputContainer && window.visualViewport.height < window.innerHeight) {
                        inputContainer.style.bottom = `${window.innerHeight - window.visualViewport.height}px`;
                    } else if (inputContainer) {
                        inputContainer.style.bottom = '0px';
                    }
                });
            }

            // Add haptic feedback for supported devices
            function addHapticFeedback(element) {
                if ('vibrate' in navigator) {
                    element.addEventListener('touchstart', () => {
                        navigator.vibrate(10); // Light haptic feedback
                    });
                }
            }

            // Add haptic feedback to interactive elements
            document.querySelectorAll('.quick-reply, .theme-card, .quiz-option, .btn').forEach(addHapticFeedback);
        });

        function startRoleplay(scenario) {
            showSection('chat');
            
            const scenarios = {
                food: { malay: "Selamat datang! Nak order apa?", english: "Welcome! What would you like to order?" },
                shopping: { malay: "Nak beli apa hari ni?", english: "What would you like to buy today?" },
                directions: { malay: "Boleh saya tolong?", english: "Can I help you?" },
                clinic: { malay: "Apa masalah awak hari ni?", english: "What's your problem today?" },
                shop: { malay: "Cari apa, bang?", english: "What are you looking for, bro?" },
                bank: { malay: "Selamat pagi. Saya mahu buka akaun untuk anak saya.", english: "Good morning. I want to open an account for my child." },
                jobinterview: { malay: "Boleh perkenalkan diri?", english: "Can I introduce myself?" },
                hotel: { malay: "Selamat petang. Saya mahu daftar masuk.", english: "Good afternoon. I want to check in." },
                emergency: { malay: "Encik, anak saya hilang di pasar.", english: "Sir, my child is lost in the market." },
                friends: { malay: "Hai, nama saya Farah. Awak siapa?", english: "Hi, my name is Farah. Who are you?" },
                postoffice: { malay: "Saya mahu hantar bungkusan ke Johor.", english: "I want to send a package to Johor." },
                housing: { malay: "Saya mahu lihat rumah sewa tiga bilik.", english: "I want to view a three-room rental house." },
                cultural: { malay: "Nenek, kenapa ramai orang hari ini?", english: "Grandmother, why are there so many people today?" }
            };
            
            // Clear chat and start scenario
            document.getElementById('chat-container').innerHTML = '';
            const intro = scenarios[scenario];
            addMessage(intro.malay, false, intro.english);
        }

        // Daily Phrases Functions
        function getAllPhrases() {
            let allPhrases = [];
            for (let week in phrasesData) {
                for (let category in phrasesData[week].categories) {
                    phrasesData[week].categories[category].forEach(phrase => {
                        allPhrases.push({
                            ...phrase,
                            week: parseInt(week),
                            category: category,
                            weekTitle: phrasesData[week].title
                        });
                    });
                }
            }
            return allPhrases;
        }

        function updateCurrentPhrase() {
            const allPhrases = getAllPhrases();
            const phrase = allPhrases[currentPhraseIndex];
            
            document.getElementById('phrase-malay').textContent = phrase.malay;
            document.getElementById('phrase-english').textContent = phrase.english;
            document.getElementById('phrase-week').textContent = `Week ${phrase.week}`;
            document.getElementById('phrase-category').textContent = phrase.category;
        }

        function nextPhrase() {
            const allPhrases = getAllPhrases();
            currentPhraseIndex = (currentPhraseIndex + 1) % allPhrases.length;
            updateCurrentPhrase();
        }

        function previousPhrase() {
            const allPhrases = getAllPhrases();
            currentPhraseIndex = currentPhraseIndex === 0 ? allPhrases.length - 1 : currentPhraseIndex - 1;
            updateCurrentPhrase();
        }

        function randomPhrase() {
            const allPhrases = getAllPhrases();
            currentPhraseIndex = Math.floor(Math.random() * allPhrases.length);
            updateCurrentPhrase();
        }

        function speakPhrase() {
            const phraseText = document.getElementById('phrase-malay').textContent;
            speakMalayText(phraseText);
            
            // Award points for listening to phrases
            playerProfile.phrasesMastered++;
            addPoints(2, 'Phrase Listened');
            checkBadges();
        }

        function speakMalayText(text) {
            // Enhanced speech function with better mobile support
            if (!text || text.trim() === '') {
                console.log('No text to speak');
                return;
            }

            // Check if Web Speech API is available
            if ('speechSynthesis' in window) {
                try {
                    // Stop any ongoing speech
                    speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // Configure for Malay with fallbacks
                    utterance.lang = 'ms-MY'; // Primary: Malaysian Malay
                    utterance.rate = 0.7; // Slower for learning
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    
                    // Add event listeners for better debugging
                    utterance.onstart = function() {
                        console.log('üîä Speech started:', text);
                        // Add visual feedback
                        document.querySelectorAll('.phrase-audio-btn, .phrase-card-btn').forEach(btn => {
                            if (btn.onclick && btn.onclick.toString().includes(text)) {
                                btn.style.background = 'rgba(255,255,255,0.5)';
                                btn.textContent = 'üîä Speaking...';
                            }
                        });
                    };
                    
                    utterance.onend = function() {
                        console.log('‚úÖ Speech ended');
                        // Reset button appearance
                        document.querySelectorAll('.phrase-audio-btn, .phrase-card-btn').forEach(btn => {
                            if (btn.textContent.includes('Speaking')) {
                                btn.style.background = '';
                                btn.textContent = 'üîä Listen';
                            }
                        });
                    };
                    
                    utterance.onerror = function(event) {
                        console.error('‚ùå Speech error:', event.error);
                        showAudioFallback(text);
                    };
                    
                    // Wait for voices to be loaded
                    if (speechSynthesis.getVoices().length === 0) {
                        speechSynthesis.addEventListener('voiceschanged', function() {
                            speakWithBestVoice(utterance, text);
                        }, { once: true });
                    } else {
                        speakWithBestVoice(utterance, text);
                    }
                    
                } catch (error) {
                    console.error('Speech synthesis error:', error);
                    showAudioFallback(text);
                }
            } else {
                console.log('Speech synthesis not supported');
                showAudioFallback(text);
            }
        }

        function speakWithBestVoice(utterance, text) {
            const voices = speechSynthesis.getVoices();
            console.log('Available voices:', voices.length);
            
            // Try to find the best Malay voice
            let malayVoice = voices.find(voice => 
                voice.lang === 'ms-MY' || 
                voice.lang === 'ms' ||
                voice.lang.startsWith('ms')
            );
            
            // Fallback to Indonesian if Malay not available (similar language)
            if (!malayVoice) {
                malayVoice = voices.find(voice => 
                    voice.lang === 'id-ID' || 
                    voice.lang === 'id' ||
                    voice.lang.startsWith('id')
                );
            }
            
            // Final fallback to English
            if (!malayVoice) {
                malayVoice = voices.find(voice => 
                    voice.lang === 'en-US' || 
                    voice.lang === 'en-GB' ||
                    voice.lang.startsWith('en')
                );
                console.log('‚ö†Ô∏è Using English voice as fallback');
            }
            
            if (malayVoice) {
                utterance.voice = malayVoice;
                console.log('üéôÔ∏è Using voice:', malayVoice.name, malayVoice.lang);
            }
            
            // Try to speak with timeout fallback
            const timeoutId = setTimeout(() => {
                speechSynthesis.cancel();
                console.log('‚ö†Ô∏è Speech timeout, trying fallback');
                showAudioFallback(text);
            }, 5000);
            
            utterance.onend = function() {
                clearTimeout(timeoutId);
                console.log('‚úÖ Speech completed successfully');
                // Reset button appearance
                document.querySelectorAll('.phrase-audio-btn, .phrase-card-btn').forEach(btn => {
                    if (btn.textContent.includes('Speaking')) {
                        btn.style.background = '';
                        btn.textContent = 'üîä Listen';
                    }
                });
            };
            
            utterance.onerror = function(event) {
                clearTimeout(timeoutId);
                console.error('‚ùå Speech error:', event.error);
                showAudioFallback(text);
            };
            
            speechSynthesis.speak(utterance);
        }

        function showAudioFallback(text) {
            // Visual feedback when audio fails
            const fallbackMsg = document.createElement('div');
            fallbackMsg.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #ff9800;
                color: white;
                padding: 10px 20px;
                border-radius: 25px;
                z-index: 1000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            fallbackMsg.textContent = `üîá Audio not available. Text: "${text}"`;
            document.body.appendChild(fallbackMsg);
            
            // Remove after 3 seconds
            setTimeout(() => {
                document.body.removeChild(fallbackMsg);
            }, 3000);
            
            // Reset button appearance
            document.querySelectorAll('.phrase-audio-btn, .phrase-card-btn').forEach(btn => {
                if (btn.textContent.includes('Speaking')) {
                    btn.style.background = '';
                    btn.textContent = 'üîä Listen';
                }
            });
        }

        // Test audio on page load
        function testAudioSupport() {
            if ('speechSynthesis' in window) {
                console.log('‚úÖ Speech synthesis supported');
                
                // Warm up the speech system
                const testUtterance = new SpeechSynthesisUtterance('');
                testUtterance.volume = 0;
                speechSynthesis.speak(testUtterance);
                
                // Load voices
                setTimeout(() => {
                    const voices = speechSynthesis.getVoices();
                    console.log('üì± Available voices:', voices.length);
                    if (voices.length > 0) {
                        const malayVoices = voices.filter(v => v.lang.includes('ms') || v.lang.includes('id'));
                        console.log('üá≤üáæ Malay/Indonesian voices found:', malayVoices.length);
                    }
                }, 100);
            } else {
                console.log('‚ùå Speech synthesis not supported');
            }
        }

        function testSpeech() {
            speakMalayText('Selamat pagi. Audio test berjaya!');
        }

        function selectWeek(weekNum) {
            currentWeek = weekNum;
            
            // Update active week button
            document.querySelectorAll('.week-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.week-btn')[weekNum - 1].classList.add('active');
            
            // Display phrases for selected week
            displayWeekPhrases(weekNum);
        }

        function displayWeekPhrases(weekNum) {
            const weekData = phrasesData[weekNum];
            const phrasesList = document.getElementById('phrases-list');
            
            let html = `<h3 style="grid-column: 1/-1; text-align: center; color: #2c3e50; margin-bottom: 20px;">
                Week ${weekNum}: ${weekData.title}
            </h3>`;
            
            for (let category in weekData.categories) {
                weekData.categories[category].forEach(phrase => {
                    html += `
                        <div class="phrase-card">
                            <div class="phrase-card-category">${category}</div>
                            <div class="phrase-card-malay">${phrase.malay}</div>
                            <div class="phrase-card-english">${phrase.english}</div>
                            <button class="phrase-card-btn" onclick="speakText('${phrase.malay}')">üîä Listen</button>
                        </div>
                    `;
                });
            }
            
            phrasesList.innerHTML = html;
        }

        function getTodaysWeek() {
            // Get current day of year and cycle through weeks 1-8
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));
            return ((Math.floor(dayOfYear / 7) % 8) + 1);
        }

        function getTodaysPhraseIndex() {
            // Get a consistent phrase for today based on date
            const now = new Date();
            const dayOfYear = now.getDate() + (now.getMonth() * 31);
            const allPhrases = getAllPhrases();
            return dayOfYear % allPhrases.length;
        }

        function speakText(text) {
            speakMalayText(text);
        }

        function initializePhrases() {
            // Set today's phrase automatically
            currentPhraseIndex = getTodaysPhraseIndex();
            updateCurrentPhrase();
            
            // Set current week and display only that week's phrases
            const todaysWeek = getTodaysWeek();
            currentWeek = todaysWeek;
            selectWeek(todaysWeek);
        }

        // Update badges display
        function updateBadgesDisplay() {
            const badgesGrid = document.getElementById('badges-grid');
            if (!badgesGrid) return;
            
            badgesGrid.innerHTML = '';
            
            Object.keys(badges).forEach(badgeId => {
                const badge = badges[badgeId];
                const isUnlocked = playerProfile.badges.includes(badgeId);
                
                const badgeCard = document.createElement('div');
                badgeCard.className = `badge-card ${isUnlocked ? 'unlocked' : 'locked'}`;
                badgeCard.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 8px;">${badge.name.split(' ')[0]}</div>
                    <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">${badge.name.substring(2)}</div>
                    <div style="font-size: 10px; opacity: 0.8;">${badge.description}</div>
                    <div style="font-size: 11px; margin-top: 5px; color: #FFD700;">+${badge.points} ‚≠ê</div>
                `;
                
                badgesGrid.appendChild(badgeCard);
            });
        }

        // Add progress bars to all theme cards
        function addProgressToThemeCards() {
            const themes = ['greetings', 'family', 'food', 'transport', 'shopping', 'numbers', 'body', 'colors', 'weather', 'home', 'work', 'hobbies', 'directions', 'emotions'];
            
            themes.forEach(theme => {
                const themeCard = document.querySelector(`[onclick="startQuiz('${theme}')"]`);
                if (themeCard && !themeCard.querySelector('.theme-progress')) {
                    const progressHtml = `
                        <div class="theme-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-${theme}" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="progress-text-${theme}">0/7</div>
                        </div>
                    `;
                    themeCard.insertAdjacentHTML('beforeend', progressHtml);
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPlayerProfile();
            showSection('home');
            initializePhrases();
            testAudioSupport();
            addProgressToThemeCards();
            updateThemeProgress();
            updateBadgesDisplay();
        });
    </script>
</body>
</html>